<!DOCTYPE html PUBLIC "-//W3C//DTD Html 1.0 Strict//EN" "http://www.w3.org/TR/Html1/DTD/strict.dtd"><html><head><title>BRugs</title></head><body><p><font face="Arial" color="#000100" size="2"><img src="brugs0.bmp" alt="[brugs0]">&nbsp;&nbsp;&nbsp;</font><font face="Courier New" color="#000100" size="6">The BRugs dynamic link library</font><font face="Arial" color="#000100" size="6"><strong><sup><br></sup></strong></font><font face="Arial" color="#000100" size="3"><strong><sup><br></sup></strong></font><font face="Arial" color="#000100" size="3"><sup>The brugs library provides an interface to some features of the OpenBUGS software via a C friendly set of procedure. The signatures of these procedures was choosen to make interfacing to the R/Splus statistical packages easy.<br><br>The brugs library has the same interface as the Component Pascal module BugsC vis<br><br></sup></font><font face="Arial" color="#000100" size="2">&nbsp;&nbsp;&nbsp;DEFINITION BugsC&nbsp;&nbsp;&nbsp;(* nonportable (i386) *);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCEDURE [ccall] BugsCmd (VAR command: POINTER TO ARRAY [untagged] OF SHORTCHAR; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR len: INTEGER);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCEDURE [ccall] CLI;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCEDURE [ccall] CharArray (VAR procedure: POINTER TO ARRAY [untagged] OF SHORTCHAR; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR len: INTEGER; VAR x: POINTER TO ARRAY [untagged] OF SHORTCHAR; VAR lenX, res: INTEGER);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCEDURE [ccall] CmdInterpreter (VAR command: POINTER TO ARRAY [untagged] OF SHORTCHAR;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR len, res: INTEGER);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCEDURE [ccall] Guard (VAR procedure: POINTER TO ARRAY [untagged] OF SHORTCHAR; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR len, x, res: INTEGER);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCEDURE [ccall] Integer (VAR procedure: POINTER TO ARRAY [untagged] OF SHORTCHAR; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR len, x, res: INTEGER);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCEDURE [ccall] IntegerArray (VAR procedure: POINTER TO ARRAY [untagged] OF SHORTCHAR; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR len: INTEGER; VAR x: ARRAY [untagged] OF INTEGER; VAR lenX, res: INTEGER);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCEDURE [ccall] Real (VAR procedure: POINTER TO ARRAY [untagged] OF SHORTCHAR; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR len: INTEGER; VAR x, y: REAL; VAR res: INTEGER);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCEDURE [ccall] RealArray (VAR procedure: POINTER TO ARRAY [untagged] OF SHORTCHAR; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR len: INTEGER; VAR x: ARRAY [untagged] OF REAL; VAR lenX, res: INTEGER);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCEDURE [ccall] SetRoot (VAR root: POINTER TO ARRAY [untagged] OF SHORTCHAR; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR len: INTEGER);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCEDURE [ccall] SetTempDir (VAR tempDir: POINTER TO ARRAY [untagged] OF SHORTCHAR; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR len: INTEGER);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCEDURE [ccall] UseBufferFile;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCEDURE [ccall] UseConsole;<br><br>&nbsp;&nbsp;&nbsp;END BugsC.<br></font><font face="Arial" color="#000100" size="3"><br><br>In the C language this reads<br><br></font><font face="Arial" color="#000100" size="2">&nbsp;&nbsp;&nbsp;void BugsCmd(char **command, int *len)<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;void CLI ()<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;void CharArray (char **procedure, int *len, char **x, int *lenX, int *res)<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;void CmdInterpreter (char **command, int *len, int *res)<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;void Guard (char **procedure, int *len, int *x, int *res)<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;void Integer (char **procedure, int *len, int *x, int *res)<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;void IntegerArray (char **procedure, int *len, int *x, int *lenX, int *res)<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;void Real (char **procedure, int *len, double *x, double *y, int *res)<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;void RealArray (char **procedure, int *len, double *x, int *lenX, int *res)<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;void SetRoot (char **root, int *len)<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;void SetTempDir(char **tempDir, int *len)<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;void UseBufferFile ()<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;void UseConsole ()<br></font><font face="Arial" color="#000100" size="3">&nbsp;&nbsp;&nbsp;<br>The first two procedures in the library provide an interface to the BUGS scripting language and ClassicBUGS. BugsCmd takes one string argument 'command' and executes this command if it is a valid command in the BUGS scripting language. The CLI procedure sets up the ClassicBUGS command line interface and will terminate when 'quit' is typed at the command prompt. The first time CLI is called, a welcome message should be displayed on the console.<br><br>The UseBufferFile and UseConsole procedures can be used to direct output to a buffer file or to the console. The buffer file is always called buffer.txt, but the directory into which it is created can be changed by the procedure SetTempDir. SetRoot sets the root directory that OpenBUGS will search from to find a file. If SetRoot is not called, OpenBUGS uses the current directory of the invoking process.<br><br>Procedures CharArray, CmdInterpreter, Guard, Integer, IntegerAray, Real and RealArray provide an interface to Component Pascal procedures in the OpenBUGS software.They allow named procedures in the OpenBUGS software to be called. The string argument 'procedure' is the name of the Component Pascal procedure to be called. 'procedure' is literally the name of the module containing the procedure, a period, and then the name of the procedure. In the above declarations 'res' is the exit status.The 'res' argument is set to a non zero value if it is not possible to call the Component Pascal procedure. This could be because the module or procedure does not exist (res = 1), the procedure was called with the wrong type of argument (res = 2) or the procedure has the wrong signature (res = 3). <br><br>CharArray calls a procedure which takes an array of characters as argument. Integer calls a procedure which returns an integer (or boolean). IntegerArray calls a procedure which takes an array of integer as argument. Real calls a procedure which takes an 8 byte real as argument and returns an 8 byte real. RealArray calls a procedure which takes an array of 8 byte reals as argument. In general array arguments to these procedures can either be VAR, IN or OUT parameters and for the case of CharArray a value parameter is also allowed. <br><br>The CmdInterpreter, is able to interpret a quite general sequence of semi-colon delimited Component Pascal procedures. These procedure can take literal value parameters, which must be given after the procedure name as string literals within parenthesis (string arguments need to be enclosed in single quotes). The Guard procedure calls a Component Pascal procedure that has a single boolean argument of OUT type. If this procedure sets the boolean to true Guard sets its x argument to one otherwise to zero. The Guard procedure can be used to test for some logical condition before calling further Component Pascal procedure. &quot;Guard&quot; procedures can be embeded in the string of procedure passed to CmdInterpreter to short circuit execution of commands if a logical condition fails.<br><br>Where a function has a string or array type argument, the next argument the signature is an integer giving the length of the string or array.<br><br>Two examples of using the BRugs library to interface to R/Splus are<br><br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">&quot;modelCheck&quot; &lt;-<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">function(fileName)<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2"># Check that OpenBUGS model is syntactically correct<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">{<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">path &lt;- dirname(fileName)<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">path &lt;- if(path == &quot;.&quot;) getwd() else path<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">fileName &lt;- file.path(path, basename(fileName))<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">if(!file.exists(fileName))<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">stop(&quot;File &quot;, fileName, &quot; does not exist&quot;)<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">if(file.info(fileName)$isdir) <br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">stop(fileName, &quot; is a directory, but a file is required&quot;)<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">command &lt;- paste(&quot;BugsEmbed.SetFilePath(&quot;, sQuote(fileName), <br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">&quot;);BugsEmbed.ParseGuard;BugsEmbed.Parse&quot;, sep = &quot;&quot;)<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">if (!is.R()) {<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">command &lt;- gsub (&quot;\\\\&quot;, &quot;/&quot;, command)<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">command &lt;- gsub (&quot;//&quot;, &quot;/&quot;, command)<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">}<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">.C(&quot;CmdInterpreter&quot;, command, nchar(command), integer(1), PACKAGE = &quot;BRugs&quot;)<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">if(getOption(&quot;BRugsVerbose&quot;)) <br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">buffer()<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></font><font face="Arial" color="#000100" size="3">and&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">&nbsp;&nbsp;&nbsp;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;currentValues&quot; &lt;- <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function(nodeLabel)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Get current value of node<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodeLabel &lt;- as.character(nodeLabel)<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command &lt;- &quot;BugsRobjects.SetVariable&quot;<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len &lt;- nchar(command)<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.C(&quot;CharArray&quot;, command, as.integer(len), nodeLabel, nchar(nodeLabel), integer(1), PACKAGE=&quot;BRugs&quot;)<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command &lt;- &quot;BugsRobjects.GetSize&quot;<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodeSize &lt;- .C(&quot;Integer&quot;, command, nchar(command), integer(1), integer(1), PACKAGE=&quot;BRugs&quot;)[[3]]<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(nodeSize == -1) <br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stop(nodeLabel, &quot; is not a node in BUGS model&quot;)<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command &lt;- &quot;BugsRobjects.GetValues&quot;<br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.C(&quot;RealArray&quot;, command, nchar(command), as.real(rep(NA, nodeSize)), <br></font><font face="Arial" color="#000100" size="1">&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#000100" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;as.integer(nodeSize), integer(1), NAOK = TRUE, PACKAGE=&quot;BRugs&quot;)[[3]]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br><br></font><font face="Arial" color="#000100" size="3">Note in the second R function the allocation of the array variable which will contain the current values of the node is done in R.</font></p></body></html>