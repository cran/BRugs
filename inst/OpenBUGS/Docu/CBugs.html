<!DOCTYPE html PUBLIC "-//W3C//DTD Html 1.0 Strict//EN" "http://www.w3.org/TR/Html1/DTD/strict.dtd"><html><head><title>CBugs</title></head><body><p><font face="Arial" color="#008040" size="3">/*<img src="bugsicon.jpg" alt="[bugsicon]">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#0000FF" size="2"><u><a href="../GNU-Licence.html">GNU&nbsp;General&nbsp;Public&nbsp;Licence</u></font><font face="Arial" color="#008040" size="3"></a><br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;This is the &quot;classic&quot; interface to BUGS with no Windows stuff.<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;The brugs dynamic link library is used in the same way as in the R interface to BUGS:<br>&nbsp;&nbsp;&nbsp;via dlopen and dlsym.<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;The names of commands typed at the command prompt are the same as the names in the<br>&nbsp;&nbsp;&nbsp;BUGS scipt language and of the R functions in BRugs.<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;The mappings between the command names and the Component Pascal procedures to<br>&nbsp;&nbsp;&nbsp;execute them are in the file Bugs/Rsrc/Script.txt<br>&nbsp;&nbsp;&nbsp;<br>*/<br><br><br>/* <br><br>&nbsp;&nbsp;&nbsp;Save this file as a .c file before compiling with a C compiler.<br><br>&nbsp;&nbsp;&nbsp;Compile with gcc -o CBugs CBugs.c -ldl&nbsp;&nbsp;&nbsp;on Linux and use the shell script LinBUGS to <br>&nbsp;&nbsp;&nbsp;provide the command line arguments.<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;Compile with the Cygwin c compiler gcc -o CBugs.exe CBugs.c &nbsp;&nbsp;&nbsp;on Windows<br>&nbsp;&nbsp;&nbsp;The Windows version needs the library cygwin1.dll. Use the short cut ClassicBUGS to provide &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the command line arguments.<br><br>*/<br><br></font><font face="Arial" color="#000100" size="3">#include &lt;dlfcn.h&gt;<br>#include &lt;stdio.h&gt;<br>#include &lt;string.h&gt;<br><br>int </font><font face="Arial" color="#804000" size="3"><strong>main </strong></font><font face="Arial" color="#000100" size="3">(int argc, char **argv)<br>{<br>&nbsp;&nbsp;&nbsp;void * handle;<br>&nbsp;&nbsp;&nbsp;void (*SetRootDir) (char **string, int *len);<br>&nbsp;&nbsp;&nbsp;void (*SetTempDir) (char **string, int *len);&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;void (*EmbedCommand) (char ** string, int *len);<br>&nbsp;&nbsp;&nbsp;char ch;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;char *error;<br>&nbsp;&nbsp;&nbsp;char *root;<br>&nbsp;&nbsp;&nbsp;char *tempDir;<br>&nbsp;&nbsp;&nbsp;char *dll;<br>&nbsp;&nbsp;&nbsp;char *library;<br>&nbsp;&nbsp;&nbsp;char *buffer;<br>&nbsp;&nbsp;&nbsp;char *logFile;<br>&nbsp;&nbsp;&nbsp;char *cmd;<br>&nbsp;&nbsp;&nbsp;char cmdLine[256];<br>&nbsp;&nbsp;&nbsp;int i;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;int len;<br>&nbsp;&nbsp;&nbsp;int len1;<br>&nbsp;&nbsp;&nbsp;int len2;<br>&nbsp;&nbsp;&nbsp;int len3;<br>&nbsp;&nbsp;&nbsp;int pos;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;int res;<br>&nbsp;&nbsp;&nbsp;int tabs[20];<br>&nbsp;&nbsp;&nbsp;FILE *fp;<br>&nbsp;&nbsp;&nbsp;FILE *log;<br><br>&nbsp;&nbsp;&nbsp;if(argc != 4) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(stderr, &quot;%s\n&quot;, &quot;error must give root directory of BUGS, temp directory and library name as command line parameter&quot;);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(1);<br>&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;root = argv[1],&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;len1 = strlen(root);<br>&nbsp;&nbsp;&nbsp;tempDir = argv[2];<br>&nbsp;&nbsp;&nbsp;len2 = strlen(tempDir);<br>&nbsp;&nbsp;&nbsp;dll = argv[3];<br>&nbsp;&nbsp;&nbsp;len3 = strlen(dll);<br>&nbsp;&nbsp;&nbsp;library = (char *) malloc((len1 + len3 + 1) * sizeof(char));<br>&nbsp;&nbsp;&nbsp;strcpy(library, root);<br>&nbsp;&nbsp;&nbsp;strcat(library, dll);<br>&nbsp;&nbsp;&nbsp;buffer = (char *) malloc((len2 + 12) * sizeof(char));<br>&nbsp;&nbsp;&nbsp;strcpy(buffer, tempDir);<br>&nbsp;&nbsp;&nbsp;strcat(buffer, &quot;/buffer.txt&quot;);<br>&nbsp;&nbsp;&nbsp;logFile = (char *) malloc((len2 + 13) * sizeof(char));<br>&nbsp;&nbsp;&nbsp;strcpy(logFile, tempDir);<br>&nbsp;&nbsp;&nbsp;strcat(logFile, &quot;/bugslog.txt&quot;);<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;handle = dlopen(library, RTLD_LAZY);<br>&nbsp;&nbsp;&nbsp;if (!handle)<br>&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fputs(dlerror(), stderr);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(1);<br>&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;SetRootDir = dlsym(handle, &quot;SetRootDir&quot;);<br>&nbsp;&nbsp;&nbsp;error = dlerror();<br>&nbsp;&nbsp;&nbsp;if(error != NULL)<br>&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(stderr, &quot;%s\n&quot;, error);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(1);<br>&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;SetTempDir = dlsym(handle, &quot;SetTempDir&quot;);<br>&nbsp;&nbsp;&nbsp;error = dlerror();<br>&nbsp;&nbsp;&nbsp;if(error != NULL)<br>&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(stderr, &quot;%s\n&quot;, error);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(1);<br>&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;EmbedCommand = dlsym(handle, &quot;EmbedCommand&quot;);<br>&nbsp;&nbsp;&nbsp;error = dlerror();<br>&nbsp;&nbsp;&nbsp;if(error != NULL)<br>&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(stderr, &quot;%s\n&quot;, error);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(1);<br>&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;len = strlen(root);<br>&nbsp;&nbsp;&nbsp;SetRootDir(&amp;root, &amp;len);<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;len = strlen(tempDir);<br>&nbsp;&nbsp;&nbsp;SetTempDir(&amp;tempDir, &amp;len);<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;</font><font face="Arial" color="#008080" size="3">/*&nbsp;&nbsp;&nbsp;Initialize by executing Pascal procedures corresponding to INIT()&nbsp;&nbsp;&nbsp;*/</font><font face="Arial" color="#000100" size="3"><br>&nbsp;&nbsp;&nbsp;len = 6;<br>&nbsp;&nbsp;&nbsp;cmd = (char *) malloc ((len + 1) * sizeof(char));<br>&nbsp;&nbsp;&nbsp;strcpy(cmd, &quot;INIT()&quot;);<br>&nbsp;&nbsp;&nbsp;EmbedCommand(&amp;cmd, &amp;len);<br>&nbsp;&nbsp;&nbsp;free(cmd);<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;log = fopen(logFile, &quot;w&quot;);<br><br>&nbsp;&nbsp;&nbsp;tabs[0] = 1;<br>&nbsp;&nbsp;&nbsp;tabs[1] = 20;<br>&nbsp;&nbsp;&nbsp;i = 2;<br>&nbsp;&nbsp;&nbsp;while (i &lt; 20) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tabs[i] = 12;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = i + 1;<br>&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;while (1){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%s&quot;, &quot;Bugs&gt; &quot;);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(log, &quot;%s&quot;, &quot;Bugs&gt; &quot;);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gets(cmdLine);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(log, &quot;%s&quot;, cmdLine);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(log, &quot;%c&quot;, '\n');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (strcmp(cmdLine, &quot;modelQuit()&quot;) == 0) exit(0);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len = strlen(cmdLine);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd = (char *) malloc((len + 1) * sizeof(char));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcpy(cmd, cmdLine);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EmbedCommand(&amp;cmd, &amp;len);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free(cmd);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fp = fopen(buffer, &quot;r&quot;);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ch = fgetc(fp);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (ch != EOF) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos = pos + 1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ch == '\n') {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ch == '\t') {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos = pos % tabs[i];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (pos &lt; tabs[i]) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos = pos + 1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%c&quot;, ' ');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(log, &quot;%c&quot;, ' ');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = i + 1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ch != '\t') {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%c&quot;, ch);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(log, &quot;%c&quot;, ch);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ch = fgetc(fp);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(fp);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;fclose(log);<br>&nbsp;&nbsp;&nbsp;dlclose(handle);<br>&nbsp;&nbsp;&nbsp;return 0;<br>}<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></font><font face="Arial" color="#000100" size="2"><br></font><font face="Arial" color="#000100" size="1"><br></font></p></body></html>